<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Minecraft Map Navigator - Pirate's Chart</title>
    <script>
        // Dynamic base path configuration for local & GitHub Pages compatibility
        (function () {
            const getBasePath = () => {
                const href = window.location.href;
                if (href.includes('github.io')) {
                    const parts = new URL(href).pathname.split('/').filter(Boolean);
                    if (parts.length > 1 && !parts[0].includes('.')) {
                        return '/' + parts[0] + '/';
                    }
                }
                return '/';
            };
            const basePath = getBasePath();
            if (basePath !== '/') {
                document.write('<base href="' + basePath + '">');
            }
            window.BASE_PATH = basePath;
        })();
    </script>
    <script src="https://cdn.tailwindcss.com" defer></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <script src="global.js" defer></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: none;
        }

        html {
            width: 100%;
            height: 100dvh;
            overflow: hidden;
            -webkit-user-select: none;
            user-select: none;
        }

        :root {
            --mc-bg: #8B8B8B;
            --mc-border-light: #DBDBDB;
            --mc-border-dark: #555555;
            --map-paper: #C6B58A;
            --mc-gold: #FFAA00;
        }

        /* MC Style Containers (Point 7) */
        .emerald-container {
            background: #00A86B;
            border: 4px solid #004020;
            box-shadow: inset -4px -4px 0 #00703B, inset 4px 4px 0 #55FFC0;
            color: white;
            padding: 10px;
        }

        .ash-container {
            background: #444;
            border: 4px solid #1A1A1A;
            box-shadow: inset -4px -4px 0 #2C2C2C, inset 4px 4px 0 #888;
            color: #ddd;
            padding: 10px;
        }

        .pixelated {
            image-rendering: pixelated;
        }

        body {
            background-color: #000;
            font-family: 'VT323', monospace;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100dvh;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            image-rendering: pixelated;
            box-sizing: border-box;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        /* Cinematic Background */
        .background-layer {
            position: fixed;
            inset: 0;
            background-image: url('images/location.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            z-index: -10;
            transition: background-image 0.5s ease;
        }

        .background-layer::after {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            pointer-events: none;
        }

        .mc-map-container {
            position: relative;
            width: 95%;
            max-width: 480px;
            margin: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }

        /* Clean map paper frame */
        .mc-map-paper {
            background:
                /* Texture Layer (Noise) */
                url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.6' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E"),
                /* Fold Lines & Crinkles */
                repeating-linear-gradient(45deg, transparent 0, transparent 150px, rgba(0, 0, 0, 0.03) 151px, transparent 152px),
                repeating-linear-gradient(-45deg, transparent 0, transparent 200px, rgba(0, 0, 0, 0.02) 201px, transparent 202px),
                /* Aged Stains & Burnt Edges */
                radial-gradient(circle at 10% 10%, rgba(93, 64, 55, 0.2) 0%, transparent 40%),
                radial-gradient(circle at center, #f5f5dc 0%, #d2b48c 75%, #3d2b1f 100%);
            padding: 40px 25px;
            position: relative;
            width: 100%;
            aspect-ratio: 1 / 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: hidden;

            border: 6px solid rgba(61, 31, 8, 0.65);
            border-radius: 4px;
            filter: drop-shadow(0 15px 30px rgba(0, 0, 0, 0.7));
            box-shadow: inset 0 0 80px rgba(61, 31, 8, 0.4);
            box-shadow: inset 0 0 80px rgba(61, 31, 8, 0.4);
        }

        @media (max-width: 480px) {
            .mc-map-paper {
                padding: 20px 15px;
            }
        }

        /* Wax Seal Decoration (Refined) */
        .mc-map-paper::after {
            content: '⚓';
            position: absolute;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            background: radial-gradient(circle at 30% 30%, #a30000, #6d0000);
            color: #ffaa00;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.6), inset -5px -5px 8px rgba(0, 0, 0, 0.5), inset 5px 5px 8px rgba(255, 255, 255, 0.1);
            border: 3px solid #4d0000;
            transform: rotate(-10deg);
            opacity: 0.95;
            z-index: 10;
        }

        /* Visible inset edge */
        .mc-map-paper::before {
            content: '';
            position: absolute;
            inset: 8px;
            background: transparent;
            border: 2px dashed rgba(61, 31, 8, 0.25);
            border-radius: 2px;
            pointer-events: none;
            z-index: 5;
        }

        .mc-button {
            padding: 12px 16px;
            color: white;
            text-shadow: 2px 2px #000;
            cursor: pointer;
            font-family: 'VT323', monospace;
            font-size: 1.5rem;
            width: 100%;
            margin-top: 10px;
            text-align: center;
            border: none;
            background: #8B8B8B;
            transition: all 0.1s;
        }

        .mc-button:active {
            transform: translateY(4px);
        }

        .mc-input {
            background: #000;
            border: 4px solid #555;
            color: #FFAA00;
            padding: 10px;
            font-family: 'VT323', monospace;
            font-size: 1.5rem;
            text-align: center;
            width: 100%;
            margin-bottom: 10px;
            outline: none;
        }

        .mc-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .mc-modal {
            padding: 24px;
            width: 85%;
            max-width: 350px;
            text-align: center;
        }

        #reader-wrapper {
            width: 100%;
            aspect-ratio: 1/1;
            margin: 0 auto;
            position: relative;
            border: 6px solid #5A2D0C;
            background: #000;
            overflow: hidden;
            box-shadow: inset 0 0 30px rgba(0, 0, 0, 1);
        }

        #reader {
            width: 100% !important;
            height: 100% !important;
        }

        #reader video {
            object-fit: cover !important;
            width: 100% !important;
            height: 100% !important;
        }

        .scanner-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(to bottom, transparent, #FFAA00, transparent);
            box-shadow: 0 0 15px #FFAA00;
            animation: scan 3s linear infinite;
            z-index: 20;
            pointer-events: none;
        }

        @keyframes scan {
            0% {
                top: 0;
            }

            50% {
                top: 100%;
            }

            100% {
                top: 0;
            }
        }

        /* Global HUD Override for TV Style */
        .global-hud {
            position: fixed !important;
            top: 10px !important;
            left: 10px !important;
            right: auto !important;
            width: auto !important;
            z-index: 10000 !important;
        }

        .tv-logo {
            width: 80px !important;
            height: auto !important;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5)) !important;
        }

        body>img[src*="logo.png"]:not(.tv-logo) {
            display: none !important;
        }

        .mc-character {
            position: absolute;
            width: 80px;
            height: 80px;
            z-index: 50;
            transition: all 1s cubic-bezier(0.34, 1.56, 0.64, 1);
            pointer-events: none;
            filter: drop-shadow(0 5px 10px rgba(0, 0, 0, 0.5));
            bottom: -20px;
        }

        .mc-character-inner {
            animation: characterBounce 0.6s ease-in-out infinite alternate;
        }

        @keyframes characterBounce {
            from {
                transform: translateY(0);
            }

            to {
                transform: translateY(-12px);
            }
        }

        .hidden {
            display: none !important;
        }

        .path-container {
            width: 100%;
            margin: 10px 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .path-item {
            background: rgba(0, 0, 0, 0.05);
            border: 2px dashed #8b4513;
            padding: 10px;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .path-item:hover {
            background: rgba(255, 170, 0, 0.1);
            border-style: solid;
        }

        /* Jump Track Toast */
        .jump-toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: rgba(180, 30, 30, 0.95);
            border: 4px solid #ff4444;
            box-shadow: 0 0 40px rgba(255, 0, 0, 0.5), inset 0 0 20px rgba(0, 0, 0, 0.3);
            color: #fff;
            padding: 20px 32px;
            font-family: 'VT323', monospace;
            font-size: 2rem;
            text-align: center;
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            animation: jumpToastAnim 2.5s ease forwards;
        }

        .jump-toast .jump-sub {
            font-size: 1rem;
            color: #ffcccc;
            margin-top: 4px;
        }

        @keyframes jumpToastAnim {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }

            15% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.05);
            }

            85% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }

            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.9);
            }
        }
    </style>
</head>

<body>
    <div class="background-layer" id="bgLayer"></div>

    <div class="mc-map-container">
        <div id="skull-sparrow" class="mc-character">
            <div class="mc-character-inner">
                <img src="images/sp1.png" alt="Pirate" class="pixelated">
            </div>
        </div>

        <div class="mc-map-paper wanted-poster">
            <h1 class="text-3xl text-[#3d2b1f] mb-2 text-center font-bold">⚓ PIRATE CHART ⚓</h1>

            <div id="status-area" class="w-full text-center mb-4 border-b border-[#8b4513] border-dashed pb-2">
                <span id="node-id" class="hidden"></span>

                <!-- Voyage Log Section -->

                <!-- Voyage Log Section -->
                <div class="mt-4 p-2 bg-[#6f3f1d]/80 border border-[#4a2a12] rounded">
                    <p class="text-[0.6rem] uppercase tracking-tighter text-[#f2d4b5] mb-1">Voyage History</p>
                    <p id="journey-breadcrumb" class="text-xs text-[#f7e7d0] font-mono tracking-widest break-all"></p>
                </div>
            </div>

            <div id="path-container" class="path-container"></div>

            <div id="scanner-container" class="w-full hidden absolute inset-0 z-50">
                <div id="reader-wrapper" class="relative w-full h-full">
                    <div id="reader"></div>
                    <div class="scanner-line"></div>
                    <!-- Absolute Top-Left Close Button -->
                    <button onclick="stopScanner()"
                        class="absolute top-4 left-4 w-10 h-10 bg-[#a33] border-2 border-[#5A2D0C] text-white flex items-center justify-center font-bold text-xl z-[60] shadow-lg active:scale-90 transition-transform">
                        ✕
                    </button>
                </div>
            </div>

            <div id="manual-container" class="w-full hidden mt-2">
                <!-- Password Gate -->
                <div id="password-stage" class="ash-container p-4">
                    <p class="text-lg text-white mb-2 uppercase font-bold tracking-widest">Captain's Code Required</p>
                    <input type="password" id="manual-pass" class="mc-input text-center text-xl mb-4"
                        placeholder="••••••">
                    <button class="mc-button emerald-container" onclick="verifyCaptainCode()">AUTHENTICATE</button>
                    <p id="pass-error" class="text-xs text-red-400 mt-2 hidden">INVALID CODE. ACCESS DENIED.</p>
                </div>

                <!-- Node Entry (Initially Hidden) -->
                <div id="node-stage" class="ash-container p-4 hidden">
                    <p class="text-lg text-white mb-2">ENTER TARGET NODE</p>
                    <input type="text" id="node-input" class="mc-input" placeholder="e.g. B, C, X">
                    <button class="mc-button ash-container" onclick="submitManualNode()">SET COURSE</button>
                </div>
                <button class="mc-button ash-container mt-4" onclick="hideManualOverride()">BACK</button>
            </div>

            <div id="home-ui" class="w-full flex flex-col items-center mt-4">
                <div class="w-24 h-24 bg-[#FFAA00] rounded-full flex items-center justify-center cursor-pointer border-4 border-[#5A2D0C] animate-pulse shadow-lg"
                    onclick="startScanner()">
                    <div class="scan-button-circle">
                        <svg viewBox="0 0 24 24" width="48" height="48" fill="#5A2D0C">
                            <path
                                d="M2 2h6v6H2V2zm2 2v2h2V4H4zM2 16h6v6H2v-6zm2 2v2h2v-2H4zM16 2h6v6h-6V2zm2 2v2h2V4h-2zm-2 12h2v2h-2v-2zm2 2h2v2h-2v-2zm1.2 0h2v2h-2v-2zm-2.4-2.4h2v2h-2v-2z" />
                        </svg>
                    </div>
                </div>
                <p class="mt-4 text-[#5d4037] uppercase font-bold tracking-widest">Tap to scan chart</p>
                <button onclick="showManualOverride()"
                    class="text-sm text-[#8b4513] underline mt-8 uppercase font-bold">Manual Override</button>
            </div>
        </div>
    </div>

    <!-- Success View (Replaces Modal for better flow) -->
    <div id="success-modal" class="mc-overlay hidden">
        <div class="mc-modal ash-container border-4 border-[#ffaa00]">
            <div class="text-2xl text-[#ffaa00] mb-2 font-bold tracking-tighter uppercase">Scanned Successfully!</div>
            <div id="scan-feedback" class="text-4xl text-white my-4 font-mono font-bold drop-shadow-lg"></div>
            <p id="current-msg"
                class="text-sm italic text-white/70 mb-8 border-t border-white/20 pt-4 px-4 font-mono tracking-tighter">
                Scan to update current node
            </p>
            <button class="mc-button emerald-container py-4 text-2xl" onclick="closeModal()">BACK TO SCANNER ⚓</button>
        </div>
    </div>

    <script>
        let html5QrCode = null;
        // Point 1-6 & 9: Defensive Implementation of Core Functions
        if (!window.gameState) {
            window.gameState = {
                currentNode: 'START',
                journey: [],
                jumps: [],
                targetNode: null,
                currentLevel: 3
            };
        }
        // Ensure jumps array exists on loaded state
        if (!window.gameState.jumps) window.gameState.jumps = [];

        if (!window.saveGame) {
            window.saveGame = function () {
                try { localStorage.setItem('pirateState', JSON.stringify(window.gameState)); }
                catch (e) { console.warn('Save failed', e); }
            };
        }

        if (!window.initGame) {
            window.initGame = function () {
                const saved = localStorage.getItem('pirateState');
                if (saved) Object.assign(window.gameState, JSON.parse(saved));
            };
        }

        if (!window.applyTheme) window.applyTheme = () => console.log('Theme applied');
        if (!window.playSound) window.playSound = (type) => console.log(`Sound: ${type}`);
        if (!window.updateLevel3Session) window.updateLevel3Session = (p, n, v) => console.log(`Session: ${p}->${n}`);

        let graph = null;
        let processing = false;
        const nodeBgCache = new Map();
        const ui = {
            homeUi: null,
            statusArea: null,
            pathContainer: null,
            scannerContainer: null,
            manualContainer: null,
            successModal: null,
            pageTitle: null,
            nodeId: null,
            journeyBreadcrumb: null,
            bgLayer: null,
            passError: null
        };

        function cacheUIElements() {
            ui.homeUi = document.getElementById('home-ui');
            ui.statusArea = document.getElementById('status-area');
            ui.pathContainer = document.getElementById('path-container');
            ui.scannerContainer = document.getElementById('scanner-container');
            ui.manualContainer = document.getElementById('manual-container');
            ui.successModal = document.getElementById('success-modal');
            ui.pageTitle = document.querySelector('.mc-map-paper h1');
            ui.nodeId = document.getElementById('node-id');
            ui.journeyBreadcrumb = document.getElementById('journey-breadcrumb');
            ui.bgLayer = document.getElementById('bgLayer');
            ui.passError = document.getElementById('pass-error');
        }

        function setBaseMapVisible(isVisible) {
            const method = isVisible ? 'remove' : 'add';
            ui.homeUi?.classList[method]('hidden');
            ui.statusArea?.classList[method]('hidden');
            ui.pathContainer?.classList[method]('hidden');
            ui.pageTitle?.classList[method]('hidden');
        }

        function closeScannerView() {
            ui.scannerContainer?.classList.add('hidden');
            setBaseMapVisible(true);
        }

        function syncLevel3SessionFromJourney() {
            if (!window.gameState || gameState.currentLevel !== 3) return;
            if (!gameState.teamData) return;
            if (!Array.isArray(gameState.journey) || gameState.journey.length === 0) return;

            const crewId = String(gameState.teamData.crewid || gameState.teamData.id || '').trim();
            if (!crewId) return;

            if (!gameState.level3Session || String(gameState.level3Session.crewId || '') !== crewId) {
                gameState.level3Session = {
                    crewId,
                    crewName: gameState.teamData.crewname || 'Unknown',
                    loginTime: Date.now(),
                    scannedNodes: [],
                    pathTrace: '',
                    totalMarks: 0,
                    avgScore: 0,
                    scanCount: 0,
                    lastScanTime: 0,
                    lastScanNode: null,
                    completed: false
                };
            }

            const nodes = gameState.journey.map(n => String(n || '').trim()).filter(Boolean);
            if (nodes.length === 0) return;

            const now = Date.now();
            gameState.level3Session.scannedNodes = nodes.map((node, idx) => ({
                node,
                timestamp: now - ((nodes.length - idx) * 1000),
                mark: 0
            }));
            gameState.level3Session.pathTrace = nodes.join('->');
            gameState.level3Session.scanCount = nodes.length;
            gameState.level3Session.lastScanNode = nodes[nodes.length - 1];
            gameState.level3Session.lastScanTime = now;
        }

        window.onload = function () {
            // Point 4: Path to graph.json is root-relative (Point 4)
            cacheUIElements();
            if (window.initGame) initGame();
            if (window.applyTheme) applyTheme();

            // Location page is Level 3 gameplay. Ensure correct level/session for scoring and admin updates.
            if (window.gameState) {
                if (gameState.currentLevel !== 3) gameState.currentLevel = 3;
                if (!gameState.level3Session && typeof window.initLevel3Session === 'function') {
                    window.initLevel3Session();
                }
            }

            const urlNode = new URLSearchParams(window.location.search).get('node');
            if (urlNode) {
                const scannedNode = urlNode.trim().toUpperCase();
                if (!Array.isArray(gameState.journey)) gameState.journey = [];

                // If starting fresh, enforce 'A' as the first move from 'start'
                if (gameState.journey.length === 0) {
                    const initialPos = 'START';
                    if (scannedNode === 'A') {
                        gameState.journey = [initialPos, 'A'];
                        gameState.jumps = [false];
                    } else if (scannedNode === 'START') {
                        gameState.journey = ['START'];
                        gameState.jumps = [];
                    } else {
                        // Auto-bridge start -> A -> scannedNode if it's the very first action?
                        // Actually, following user's "start -> A" logic:
                        gameState.journey = ['START', 'A', scannedNode];
                        gameState.jumps = [false, false];
                    }
                } else if (gameState.journey[gameState.journey.length - 1] !== scannedNode) {
                    gameState.journey.push(scannedNode);
                    if (!Array.isArray(gameState.jumps)) gameState.jumps = [];
                    gameState.jumps.push(false);
                }
                gameState.currentNode = scannedNode;
                syncLevel3SessionFromJourney();
                if (window.saveGame) saveGame();
            } else if (!gameState.currentNode) {
                // DEFAULT STARTING POINT
                gameState.currentNode = 'START';
                gameState.journey = [];
                gameState.jumps = [];
                syncLevel3SessionFromJourney();
                if (window.saveGame) saveGame();
            }
            const loader = window.fetchJSONCached
                ? window.fetchJSONCached('graph.json', { ttlMs: 10 * 60 * 1000 })
                : fetch('graph.json').then(res => res.json());

            loader
                .then(data => {
                    graph = data;
                    updateLocation();
                })
                .catch(err => console.warn('Graph load error:', err));
        }

        // Build the journey display string: '-' for valid moves, ',' for jumps
        function buildJourneyString() {
            if (!Array.isArray(gameState.journey) || gameState.journey.length === 0) return '';
            if (!Array.isArray(gameState.jumps)) gameState.jumps = [];
            let result = gameState.journey[0];
            for (let i = 1; i < gameState.journey.length; i++) {
                const wasJump = gameState.jumps[i - 1] === true;
                result += (wasJump ? ',' : '-') + gameState.journey[i];
            }
            return result;
        }

        function updateLocation() {
            if (!graph) return;
            const nodeId = gameState.currentNode || 'START';

            if (ui.nodeId) ui.nodeId.innerText = nodeId;

            if (!Array.isArray(gameState.journey)) gameState.journey = [];
            if (ui.journeyBreadcrumb) ui.journeyBreadcrumb.innerText = buildJourneyString();

            const bg = ui.bgLayer;
            if (bg) {
                const imgName = nodeId === 'START' ? 'location' : `node${nodeId}`;
                const imgSrc = `images/${imgName}.jpg`;

                if (nodeBgCache.get(imgSrc) === true) {
                    bg.style.backgroundImage = `url('${imgSrc}')`;
                } else if (nodeBgCache.get(imgSrc) === false) {
                    bg.style.backgroundImage = `url('images/location.jpg')`;
                } else {
                    const img = new Image();
                    img.src = imgSrc;
                    img.onload = () => {
                        nodeBgCache.set(imgSrc, true);
                        bg.style.backgroundImage = `url('${imgSrc}')`;
                    };
                    img.onerror = () => {
                        nodeBgCache.set(imgSrc, false);
                        bg.style.backgroundImage = `url('images/location.jpg')`;
                    };
                }
            }
            if (nodeId !== 'START') updateSparrowPos(nodeId);

            if (['F', 'X', 'Z'].includes(nodeId)) {
                setTimeout(() => window.location.replace('celebration.html'), 1000);
                return;
            }
        }

        // Path rendering removed — player freely scans any QR

        function updateSparrowPos(nodeId) {
            const sparrow = document.getElementById('skull-sparrow');
            const posMap = { 'A': '10%', 'B': '30%', 'C': '50%', 'D': '70%', 'F': '85%', 'X': '90%', 'Z': '95%' };
            sparrow.style.left = posMap[nodeId] || '50%';
        }

        async function startScanner() {
            setBaseMapVisible(false);
            ui.scannerContainer?.classList.remove('hidden');
            html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 20, qrbox: { width: 300, height: 300 }, aspectRatio: 1.0 };
            let started = false;
            try {
                const cameras = await Html5Qrcode.getCameras();
                if (cameras && cameras.length > 0) {
                    const rear = cameras.find(c => /back|rear|environment/i.test(c.label || ''));
                    const camId = (rear || cameras[0]).id;
                    await html5QrCode.start(camId, config, onScanSuccess);
                    started = true;
                }
            } catch (e) { console.log('Cam list fallback...'); }
            if (!started) {
                try {
                    await html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess);
                    started = true;
                } catch (err) {
                    stopScanner();
                    showManualOverride();
                }
            }
        }

        function stopScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    html5QrCode = null;
                    closeScannerView();
                }).catch(() => {
                    closeScannerView();
                });
            } else {
                closeScannerView();
            }
        }

        function onScanSuccess(decodedText) {
            if (processing) return;
            processing = true;
            let nodeId = decodedText.trim().toUpperCase();

            // Handle parameterized URLs
            if (decodedText.includes('node=')) {
                nodeId = decodedText.split('node=')[1].split('&')[0].toUpperCase();
            }

            const isFreshStart = !Array.isArray(gameState.journey) || gameState.journey.length === 0;
            const prevNode = (isFreshStart && (gameState.currentNode === 'A' || !gameState.currentNode))
                ? 'START'
                : (gameState.currentNode || 'START');

            // Check if this is a valid graph neighbor (for jump detection)
            const neighbors = graph?.graph?.[prevNode] || {};
            const isStartToA = prevNode === 'START' && nodeId === 'A';
            const isNeighbor = isStartToA || (nodeId in neighbors);
            const isJump = !isNeighbor;

            if (window.playSound) window.playSound('success');

            const isFirstMove = isFreshStart;
            if (!Array.isArray(gameState.jumps)) gameState.jumps = [];

            if (isFirstMove) {
                gameState.journey = [prevNode, nodeId];
                gameState.jumps = [isJump];
            } else if (gameState.journey[gameState.journey.length - 1] !== nodeId) {
                gameState.journey.push(nodeId);
                gameState.jumps.push(isJump);
            }

            // Track if this specific scan was a jump (for showSuccess)
            window._lastScanWasJump = isJump;

            gameState.currentNode = nodeId;

            const weight = neighbors[nodeId] || 0;
            if (window.updateLevel3Session) window.updateLevel3Session(prevNode, nodeId, weight);
            if (window.saveGame) saveGame();

            // Show jump toast if jumped
            if (isJump && prevNode !== 'START') {
                showJumpToast(prevNode, nodeId);
            }

            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    html5QrCode = null;
                    showSuccess();
                });
            } else { showSuccess(); }
        }

        function showJumpToast(fromNode, toNode) {
            const toast = document.createElement('div');
            toast.className = 'jump-toast';
            toast.innerHTML = `⚠️ JUMP TRACK ⚠️<div class="jump-sub">${fromNode} ➜ ${toNode} (off-path)</div>`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2600);
        }

        function showManualOverride() {
            setBaseMapVisible(false);
            ui.scannerContainer?.classList.add('hidden');
            ui.manualContainer?.classList.remove('hidden');

            // Show password stage first
            document.getElementById('password-stage').classList.remove('hidden');
            document.getElementById('node-stage').classList.add('hidden');
            ui.passError?.classList.add('hidden');

            const passInput = document.getElementById('manual-pass');
            passInput.value = '';
            passInput.focus();

            // Password Enter Key
            if (!passInput.dataset.listener) {
                passInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') verifyCaptainCode();
                });
                passInput.dataset.listener = 'true';
            }
        }

        function verifyCaptainCode() {
            const pass = document.getElementById('manual-pass').value.trim().toLowerCase();
            if (pass === 'skull6') {
                document.getElementById('password-stage').classList.add('hidden');
                document.getElementById('node-stage').classList.remove('hidden');

                const nodeInput = document.getElementById('node-input');
                nodeInput.value = '';
                nodeInput.focus();

                // Node Enter Key
                if (!nodeInput.dataset.listener) {
                    nodeInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') submitManualNode();
                    });
                    nodeInput.dataset.listener = 'true';
                }
            } else {
                const error = document.getElementById('pass-error');
                error.classList.remove('hidden');
                if (window.playSound) window.playSound('fail');
                setTimeout(() => error.classList.add('hidden'), 2000);
            }
        }

        function hideManualOverride() {
            ui.manualContainer?.classList.add('hidden');
            setBaseMapVisible(true);
        }

        function submitManualNode() {
            const node = document.getElementById('node-input').value.trim().toUpperCase();
            if (node) onScanSuccess(node);
        }

        function showSuccess() {
            const nodeId = gameState.currentNode || 'START';
            const journeyStr = buildJourneyString() || nodeId;
            const wasJump = window._lastScanWasJump || false;

            document.getElementById('scan-feedback').innerText = wasJump ? `⚠️ ${nodeId}` : nodeId;
            document.getElementById('current-msg').innerText = wasJump
                ? `JUMP TRACK — Path: ${journeyStr}`
                : `Path: ${journeyStr}`;

            ui.scannerContainer?.classList.add('hidden');
            ui.manualContainer?.classList.add('hidden');
            ui.successModal?.classList.remove('hidden');

            window._lastScanWasJump = false;
            updateLocation();
        }

        function closeModal() {
            processing = false;
            ui.successModal?.classList.add('hidden');
            setBaseMapVisible(true);

            updateLocation();
        }
    </script>
</body>

</html>
