<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
    <title>Bounty Pirates - Admin Command</title>
    <script>
        // Dynamic base path configuration for local & GitHub Pages compatibility
        (function () {
            const getBasePath = () => {
                const href = window.location.href;
                // Check if running on GitHub Pages
                if (href.includes('github.io')) {
                    const parts = new URL(href).pathname.split('/').filter(Boolean);
                    // If path has more than just the filename, it's a project site
                    if (parts.length > 1 && !parts[0].includes('.')) {
                        return '/' + parts[0] + '/';
                    }
                }
                // For local or user/org GitHub Pages, use root
                return '/';
            };
            const basePath = getBasePath();
            if (basePath !== '/') {
                document.write('<base href="' + basePath + '">');
            }
            window.BASE_PATH = basePath;
        })();
    </script>
    <script src="https://cdn.tailwindcss.com" defer></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-gold: #fbbf24;
            --neon-blue: #3b82f6;
            --dark-bg: #030712;
            --card-bg: rgba(17, 24, 39, 0.85);
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--dark-bg);
            color: #e2e8f0;
            overflow-x: hidden;
        }

        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Cyberpunk Grid Background */
        .cyber-grid {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background-image:
                linear-gradient(rgba(59, 130, 246, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(59, 130, 246, 0.05) 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events: none;
        }

        .cyber-grid::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 50% 50%, transparent 0%, var(--dark-bg) 90%);
        }

        /* Glassmorphism */
        .glass-panel {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0f172a;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        .tab-active {
            background: rgba(59, 130, 246, 0.15);
            border-left: 3px solid #3b82f6;
            color: #fff;
        }

        .tab-inactive {
            border-left: 3px solid transparent;
            color: #94a3b8;
        }

        .tab-inactive:hover {
            background: rgba(255, 255, 255, 0.03);
            color: #cbd5e1;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col">
    <div class="cyber-grid"></div>

    <!-- HEADER -->
    <header class="glass-panel sticky top-0 z-50 border-b border-blue-900/30">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <img src="images/logo.png" alt="Logo" class="h-8 w-auto drop-shadow-[0_0_8px_rgba(59,130,246,0.5)]">
                <div>
                    <h1
                        class="text-xl font-bold bg-gradient-to-r from-blue-400 to-amber-300 bg-clip-text text-transparent tracking-widest">
                        PIRATE<span class="text-white">OS</span>
                    </h1>
                    <p class="text-[10px] text-slate-500 font-mono tracking-[0.2em] uppercase">ADMIN COMMAND NODE</p>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <div class="flex items-center gap-2 px-3 py-1 bg-slate-900/50 rounded-full border border-slate-700/50">
                    <span class="relative flex h-2 w-2">
                        <span
                            class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                    </span>
                    <span class="text-xs font-mono text-green-400">ONLINE</span>
                </div>

                <button onclick="openGoogleSheet()"
                    class="p-2 bg-amber-600/20 hover:bg-amber-600/40 text-amber-400 rounded-lg transition-all border border-amber-500/30"
                    title="Open Google Sheet">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path
                            d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z" />
                    </svg>
                </button>

                <button onclick="refreshData()"
                    class="p-2 bg-blue-600/20 hover:bg-blue-600/40 text-blue-400 rounded-lg transition-all border border-blue-500/30">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                        </path>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- CONTENT -->
    <main class="flex-1 max-w-7xl mx-auto w-full p-4 grid grid-cols-1 lg:grid-cols-12 gap-6">

        <!-- SIDEBAR -->
        <aside class="lg:col-span-3 space-y-4">

            <!-- Stats Cards -->
            <div class="glass-panel p-5 rounded-xl border-l-4 border-amber-500">
                <h3 class="text-slate-500 text-xs font-bold uppercase tracking-wider">Top Crew</h3>
                <p id="topCrew" class="text-lg font-bold text-white mt-1 truncate">---</p>
                <p id="topScore" class="text-2xl font-mono text-amber-400">0 PTS</p>
            </div>

            <div class="glass-panel p-5 rounded-xl border-l-4 border-blue-500">
                <h3 class="text-slate-500 text-xs font-bold uppercase tracking-wider">Active Crews</h3>
                <p id="activeTeams" class="text-3xl font-mono text-white mt-1">0</p>
            </div>

            <!-- Navigation -->
            <nav class="glass-panel rounded-xl overflow-hidden p-2 space-y-1">
                <button onclick="setTab('leaderboard')" id="nav-leaderboard"
                    class="w-full text-left px-4 py-3 rounded-lg text-sm font-semibold transition-all flex items-center gap-3 tab-active">
                    <span class="text-lg">üèÜ</span> Leaderboard
                </button>
                <button onclick="setTab('l1')" id="nav-l1"
                    class="w-full text-left px-4 py-3 rounded-lg text-sm font-semibold transition-all flex items-center gap-3 tab-inactive">
                    <span class="text-lg">‚ö°</span> Level 1 (Entry)
                </button>
                <button onclick="setTab('l2')" id="nav-l2"
                    class="w-full text-left px-4 py-3 rounded-lg text-sm font-semibold transition-all flex items-center gap-3 tab-inactive">
                    <span class="text-lg">üî∞</span> Level 2 (Entry)
                </button>
                <button onclick="setTab('l3')" id="nav-l3"
                    class="w-full text-left px-4 py-3 rounded-lg text-sm font-semibold transition-all flex items-center gap-3 tab-inactive">
                    <span class="text-lg">üó∫Ô∏è</span> Level 3 (Mapping)
                </button>
                <button onclick="setTab('roster')" id="nav-roster"
                    class="w-full text-left px-4 py-3 rounded-lg text-sm font-semibold transition-all flex items-center gap-3 tab-inactive">
                    <span class="text-lg">üë•</span> Roster & Logs
                </button>
                <button onclick="setTab('timer')" id="nav-timer"
                    class="w-full text-left px-4 py-3 rounded-lg text-sm font-semibold transition-all flex items-center gap-3 tab-inactive">
                    <span class="text-lg">‚è±Ô∏è</span> Timer Control
                </button>
                <button onclick="setTab('settings')" id="nav-settings"
                    class="w-full text-left px-4 py-3 rounded-lg text-sm font-semibold transition-all flex items-center gap-3 tab-inactive">
                    <span class="text-lg">‚öôÔ∏è</span> Settings & Reset
                </button>
            </nav>

            <!-- Actions -->
            <div class="glass-panel p-4 rounded-xl space-y-2">
                <h3 class="text-xs text-slate-500 font-bold uppercase mb-2">Cloud Backup</h3>
                <button onclick="syncToSheets()" id="syncBtn"
                    class="w-full py-2 bg-green-600/20 hover:bg-green-600/40 border border-green-500/30 rounded text-xs font-mono text-green-400 transition-all flex items-center justify-center gap-2">
                    <span id="syncIcon">‚òÅÔ∏è</span> SYNC TO SHEETS
                </button>
                <button onclick="pullFromSheets()" id="pullBtn"
                    class="w-full py-2 bg-blue-600/20 hover:bg-blue-600/40 border border-blue-500/30 rounded text-xs font-mono text-blue-400 transition-all flex items-center justify-center gap-2">
                    <span id="pullIcon">üîÑ</span> PULL FROM CLOUD
                </button>
                <a href="https://docs.google.com/spreadsheets/d/17V6tx_JYPBQiQcsYWINs5cNtHd1PUgV9WnG4oHiLDCc/edit"
                    target="_blank"
                    class="w-full py-2 bg-blue-600/20 hover:bg-blue-600/40 border border-blue-500/30 rounded text-xs font-mono text-blue-400 transition-all flex items-center justify-center gap-2">
                    <span>‚ÜóÔ∏è</span> OPEN GOOGLE SHEET
                </a>
                <h3 class="text-xs text-slate-500 font-bold uppercase mb-2 mt-4">Data Controls</h3>
                <button onclick="exportLogs('all')"
                    class="w-full py-2 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded text-xs font-mono text-slate-300 transition-all">EXPORT
                    CSV</button>
                <button onclick="clearAllLogs()"
                    class="w-full py-2 bg-red-900/20 hover:bg-red-900/40 border border-red-900/50 rounded text-xs font-mono text-red-400 transition-all">WIPE
                    LOGS</button>
            </div>
        </aside>

        <!-- MAIN PANEL -->
        <div class="lg:col-span-9 flex flex-col h-full min-h-[600px]">
            <div class="glass-panel flex-1 rounded-xl overflow-hidden flex flex-col relative">

                <!-- View Header -->
                <div class="px-6 py-4 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
                    <h2 id="viewTitle" class="text-sm font-bold text-white flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-blue-500"></span>
                        LEADERBOARD
                    </h2>
                    <input type="text" id="searchInput" onkeyup="renderCurrentView()" placeholder="Search Crew..."
                        class="bg-black/20 border border-slate-700 rounded-lg text-xs text-white px-3 py-1.5 focus:border-blue-500 outline-none w-48">
                </div>

                <!-- Input Area for Logic tabs -->
                <div id="inputArea"
                    class="hidden px-6 py-4 border-b border-slate-800 bg-slate-900/30 flex gap-2 items-center">
                    <!-- Dynamic Inputs injected here -->
                </div>

                <!-- Scrollable View Area -->
                <div id="viewContainer" class="flex-1 overflow-y-auto bg-slate-900/20 relative">
                    <!-- Dynamic Content -->
                </div>

                <!-- Footer -->
                <div
                    class="px-4 py-2 bg-slate-950/80 border-t border-slate-800 text-[10px] text-slate-600 font-mono flex justify-between">
                    <span id="syncStatus">STATUS: MONITORING</span>
                    <span id="lastUpdated">-</span>
                    <span id="syncSource" class="ml-4 text-slate-700">ID: ...WqF9t</span>
                </div>
            </div>
        </div>
    </main>
    </body>
    <!-- LOGIC -->
    <script>
        // --- CONSTANTS & STATE ---
        const KEYS = {
            LOGS: 'pirateAdminLogs',
            L1: 'pirateLevel1Data',
            MANUAL: 'pirateManualData'
        };
        const DEFAULT_SHEET_URL = 'https://script.google.com/macros/s/AKfycbyNvbI4OHpyb6cd2hIURICcCeAWdjZEGJvqia4cRYd4FbImW2dNtJgVhKKan7vh_ca2/exec';

        function getSheetUrl() {
            const configured = (localStorage.getItem('google_sheet_url') || '').trim();
            return configured || DEFAULT_SHEET_URL;
        }

        // Utility: Safe HTML Escaping
        function escapeHTML(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        let state = {
            crews: [],
            logs: [],
            manual: {},   // { crewId: { login: bool, l2: {complete: bool, fails: int}, l3: int } }
            l1Data: {},   // { crewId: timestamp }
            l3Sessions: {}, // { crewId: { avgScore, totalMarks, scanCount, ... } }
            liveDevices: {}, // { crewId: { ids: Set<string>, lastSeen: number } }
            leaderboard: [],
            currentTab: 'leaderboard',
            syncMeta: { source: 'INIT', endpoint: getSheetUrl(), error: '' }
        };

        function updateSyncMeta() {
            const statusEl = document.getElementById('syncStatus');
            const sourceEl = document.getElementById('syncSource');
            if (!statusEl || !sourceEl) return;

            const src = state.syncMeta || {};
            if (src.source === 'CLOUD') {
                statusEl.innerText = `STATUS: CLOUD SYNCED (${state.logs.length} logs / ${Object.keys(state.l3Sessions || {}).length} l3)`;
                sourceEl.innerText = `SRC: ${src.endpoint}`;
                return;
            }
            if (src.source === 'LOCAL') {
                statusEl.innerText = 'STATUS: LOCAL FALLBACK';
                sourceEl.innerText = `ERR: ${(src.error || 'sync failed').toString().slice(0, 70)}`;
                return;
            }
            statusEl.innerText = 'STATUS: MONITORING';
            sourceEl.innerText = 'ID: ...WqF9t';
        }

        // Helper: Convert "HH:MM" to minutes from midnight
        function timeToMinutes(ts) {
            if (!ts || typeof ts !== 'string' || !ts.includes(':')) return 9999;
            const [h, m] = ts.split(':').map(Number);
            return (h * 60) + m;
        }

        function toTimestampMs(value) {
            if (typeof value === 'number' && !isNaN(value)) return value;
            if (!value) return 0;
            const parsed = Date.parse(value);
            return isNaN(parsed) ? 0 : parsed;
        }

        function touchLiveDevice(crewId, deviceId, timestampValue) {
            if (!crewId || crewId === 'UNKNOWN') return;
            if (!state.liveDevices[crewId]) {
                state.liveDevices[crewId] = { ids: new Set(), lastSeen: 0 };
            }
            if (deviceId) state.liveDevices[crewId].ids.add(String(deviceId));
            const ts = toTimestampMs(timestampValue);
            if (ts > state.liveDevices[crewId].lastSeen) {
                state.liveDevices[crewId].lastSeen = ts;
            }
        }

        // --- INIT ---
        window.onload = async () => {
            await fetchCrews();
            refreshData();
            // Auto refresh every 5s
            setInterval(refreshData, 5000);
        };

        function setTab(tab) {
            state.currentTab = tab;

            // Update Navigation UI
            document.querySelectorAll('[id^="nav-"]').forEach(btn => {
                const isActive = btn.id === `nav-${tab}`;
                btn.className = `w-full text-left px-4 py-3 rounded-lg text-sm font-semibold transition-all flex items-center gap-3 ${isActive ? 'tab-active' : 'tab-inactive'}`;
            });

            // Update Header Title
            const titles = {
                'leaderboard': 'LEADERBOARD RANKINGS',
                'l1': 'LEVEL 1: MANUAL TIMESTAMP ENTRY',
                'l2': 'LEVEL 2: QUIZ SUBMISSION TRACKING',
                'l3': 'LEVEL 3: MAPPING & PATH LOGS',
                'roster': 'CREW DETAILS (SENSITIVE)',
                'timer': 'TIMER CONTROL',
                'settings': 'SETTINGS & LEVEL RESET'
            };
            document.getElementById('viewTitle').innerHTML = `<span class="w-2 h-2 rounded-full bg-blue-500"></span> ${titles[tab] || tab.toUpperCase()}`;

            // Show/Hide Input Area
            const inputArea = document.getElementById('inputArea');
            if (['login', 'l1', 'l2', 'l3'].includes(tab)) {
                inputArea.classList.remove('hidden');
                renderInputArea(tab);
            } else {
                inputArea.classList.add('hidden');
            }

            renderCurrentView();
        }

        function renderInputArea(tab) {
            const container = document.getElementById('inputArea');
            container.innerHTML = '';

            if (tab === 'login') {
                container.innerHTML = `
                    <input type="text" id="manualLoginId" placeholder="Enter Crew ID (e.g. CR001)" class="bg-black/40 border border-slate-700 rounded text-sm text-white px-3 py-2 w-64 focus:border-green-500 outline-none">
                    <button onclick="addManualLogin()" class="bg-green-600 hover:bg-green-500 text-white text-sm font-bold px-4 py-2 rounded transition-all">MARK ONLINE</button>
                    <span class="text-xs text-slate-500 ml-2">Manually logs in a team bypassing digital check.</span>
                `;
            } else if (tab === 'l1') {
                container.innerHTML = `
                    <div class="flex items-center gap-4">
                        <input type="text" id="manualL1Id" placeholder="Crew ID" class="bg-black/40 border border-slate-700 rounded text-sm text-white px-3 py-2 w-32 focus:border-amber-500 outline-none">
                        <input type="text" id="manualL1Time" placeholder="Time (HH:MM)" class="bg-black/40 border border-slate-700 rounded text-sm text-white px-3 py-2 w-32 outline-none">
                        <input type="number" id="manualL1Marks" placeholder="Bonus Pts" class="bg-black/40 border border-slate-700 rounded text-sm text-white px-3 py-2 w-24 outline-none">
                        <button onclick="addManualL1()" class="bg-amber-600 hover:bg-amber-500 text-white text-sm font-bold px-4 py-2 rounded transition-all">UPDATE L1</button>
                    </div>
                `;
            } else if (tab === 'l2') {
                container.innerHTML = `
                    <div class="flex items-center gap-4">
                        <input type="text" id="manualL2Id" placeholder="Crew ID" class="bg-black/40 border border-slate-700 rounded text-sm text-white px-3 py-2 w-32 focus:border-blue-500 outline-none">
                        <select id="manualL2Status" class="bg-black/40 border border-slate-700 rounded text-sm text-white px-3 py-2 outline-none">
                            <option value="complete">Mark Complete</option>
                            <option value="incomplete">Mark Incomplete</option>
                        </select>
                        <input type="number" id="manualL2Fails" placeholder="Fails (0)" class="bg-black/40 border border-slate-700 rounded text-sm text-white px-3 py-2 w-24 outline-none">
                        <button onclick="addManualL2()" class="bg-blue-600 hover:bg-blue-500 text-white text-sm font-bold px-4 py-2 rounded transition-all">UPDATE L2</button>
                    </div>
                `;
            } else if (tab === 'l3') {
                container.innerHTML = `
                    <div class="text-xs text-slate-400 font-mono">LEVEL 3 ROSTER LOG</div>
                    <div class="text-xs text-slate-500 space-y-2">
                        <div><strong>CREW ID:</strong> Unique crew identifier</div>
                        <div><strong>CREW NAME:</strong> Crew name from crew.json</div>
                        <div><strong>SCAN PATH:</strong> Full sequence of QR nodes scanned (A‚ÜíB‚ÜíC...)</div>
                        <div><strong>LAST SCAN NODE:</strong> Most recent QR node scanned</div>
                        <div><strong>MARKS:</strong> Weighted sum of path edges (Nodes traversal weights)</div>
                    </div>
                    <button onclick="refreshData()" class="bg-purple-600 hover:bg-purple-500 text-white text-sm font-bold px-4 py-2 rounded transition-all">REFRESH L3 DATA</button>
                `;
            }
        }

        async function fetchCrews() {
            try {
                const res = await fetch('crew.json');
                if (res.ok) state.crews = await res.json();
            } catch (e) { console.error("Crew fetch failed", e); }
        }

        async function refreshData() {
            try {
                const sheetUrl = getSheetUrl();
                console.log("Fetching from:", sheetUrl);
                
                // DON'T use no-cors mode for GET requests
                const response = await fetch(sheetUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const cloudData = await response.json();
                
                if (cloudData.error) {
                    throw new Error(cloudData.error);
                }
                
                console.log("Cloud data received:", cloudData);
                
                // Reset state
                state.liveDevices = {};
                state.l1Data = {}; // Clear to prevent stale data from persisting
                state.l3Sessions = {}; // Clear to ensure fresh session data
                state.syncMeta = { source: 'CLOUD', endpoint: sheetUrl };
                
                // Map logs
                if (cloudData.logs && Array.isArray(cloudData.logs)) {
                    state.logs = cloudData.logs.map(log => {
                        let parsed = {};
                        try { 
                            parsed = typeof log.Raw === 'string' ? JSON.parse(log.Raw) : {}; 
                        } catch (e) { /* ignore */ }
                        
                        const normalized = {
                            crewId: parsed.crewId || log.Category || 'UNKNOWN',
                            type: parsed.type || log.Type || 'UNKNOWN',
                            timestamp: parsed.timestamp || log.Timestamp || Date.now(),
                            deviceId: parsed.deviceId || log.Device_ID || '',
                            sessionId: parsed.sessionId || log.Session_ID || '',
                            page: parsed.page || log.Page || '',
                            action: parsed.action || (log.Raw && log.Raw.includes('SUCCESS') ? 'SUCCESS' : 'UNKNOWN'),
                            ...parsed
                        };
                        
                        if (normalized.crewId && normalized.crewId !== 'UNKNOWN') {
                            touchLiveDevice(normalized.crewId, normalized.deviceId, normalized.timestamp);
                        }
                        
                        return normalized;
                    });
                }
                
                // Process leaderboard
                if (cloudData.leaderboard && Array.isArray(cloudData.leaderboard)) {
                    processLeaderboardData(cloudData.leaderboard);
                }
                
                // Process paths
                if (cloudData.paths && Array.isArray(cloudData.paths)) {
                    processPathData(cloudData.paths);
                }
                
                // Success!
                state.syncMeta.source = 'CLOUD';
                
            } catch (error) {
                console.error("Cloud sync failed:", error);
                state.syncMeta = { 
                    source: 'LOCAL', 
                    endpoint: getSheetUrl(), 
                    error: error.message 
                };
                
                // Fallback to localStorage if sheet is unavailable
                loadFromLocalStorage();
            }

            // Ensure L3Sessions exists
            if (!state.l3Sessions) state.l3Sessions = {};

            // Merge admin-local overrides on top of synced data (don't discard cloud user data)
            const localManual = JSON.parse(localStorage.getItem(KEYS.MANUAL) || '{}');
            Object.keys(localManual).forEach(id => {
                state.manual[id] = { ...(state.manual[id] || {}), ...(localManual[id] || {}) };
            });
            const localL1 = JSON.parse(localStorage.getItem(KEYS.L1) || '{}');
            state.l1Data = { ...(state.l1Data || {}), ...localL1 };

            calculateScores();
            updateStats();

            // Prevent DOM wipe if user is typing
            const active = document.activeElement;
            const isEditing = active && (active.tagName === 'INPUT' || active.tagName === 'SELECT');

            if (!isEditing) {
                renderCurrentView();
            } else {
                console.log("Skipping render - User is editing");
            }

            document.getElementById('lastUpdated').innerText = 'UPDATED: ' + new Date().toLocaleTimeString();
            updateSyncMeta();
        }

        // --- CORE LOGIC ---
        function calculateScores() {
            // Safety check for crews data
            if (!state.crews || !Array.isArray(state.crews) || state.crews.length === 0) {
                state.leaderboard = [];
                return;
            }

            state.leaderboard = state.crews.map(crew => {
                const id = String(crew.crewid);
                const mData = state.manual[id] || {};

                // Login
                const autoLogin = state.logs.some(l => String(l.crewId) === id && l.type === 'LOGIN');
                const isLoggedIn = autoLogin || !!mData.login;

                // L1
                const l1Ts = state.l1Data[id];
                // const l1Score = l1Ts ? 10 : 0; // Old L1 scoring

                // L2
                const l2Logs = state.logs.filter(l => String(l.crewId) === id && l.type === 'VERIFY');
                const successLog = l2Logs.find(l => l.action === 'SUCCESS');
                const autoSuccess = !!successLog;
                const autoFails = l2Logs.filter(l => l.action === 'FAILURE').length;

                // Manual Overrides
                const manualL2Data = mData.l2 || {};
                const manualTimestamp = manualL2Data.timestamp;
                const manualFails = manualL2Data.fails;

                // Determine Success & Time
                let l2Success = autoSuccess;
                let l2time = '-';

                if (manualTimestamp) {
                    l2Success = true;
                    l2time = manualTimestamp;
                } else if (successLog && successLog.timestamp) {
                    try {
                        const dateObj = new Date(successLog.timestamp);
                        if (!isNaN(dateObj.getTime())) {
                            l2time = dateObj.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });
                        }
                    } catch (e) {
                        console.warn('Failed to parse L2 timestamp:', successLog.timestamp, e);
                    }
                }

                // Determine Fails
                let l2Fails = autoFails;
                if (typeof manualFails === 'number') {
                    l2Fails = manualFails;
                }

                // Calculate Score
                // let l2Score = 0; // Old L2 scoring
                // if (l2Success) {
                //     l2Score = 10 - (l2Fails * 2);
                //     if (l2Score < 0) l2Score = 0;
                // }

                // L3: Session + Log-based Reconstruction
                const session = state.l3Sessions[id] || {};
                let l3TotalWeight = parseInt(session.totalMarks) || 0;
                let pathTrace = session.pathTrace || '-';
                let lastScanTime = session.lastScanTime || 0;
                let lastScanNode = session.lastScanNode || '-';
                let l3AvgScore = parseFloat(session.avgScore) || 0;

                // Reconstruct from logs if session is incomplete/missing
                const l3Logs = state.logs
                    .filter(l => String(l.crewId) === id && (l.type === 'LEVEL3_SCAN' || l.type === 'LOCATION'))
                    .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

                if (l3Logs.length > 0) {
                    const logMarks = l3Logs.reduce((sum, l) => sum + (parseInt(l.mark || l.points) || 0), 0);
                    // Use whichever is higher/present
                    l3TotalWeight = Math.max(l3TotalWeight, logMarks);

                    if (pathTrace === '-') {
                        const pathNodes = [];
                        l3Logs.forEach(l => {
                            if (l.from && !pathNodes.includes(l.from)) pathNodes.push(l.from);
                            if (l.to && !pathNodes.includes(l.to)) pathNodes.push(l.to);
                        });
                        pathTrace = pathNodes.join('->') || '-';
                    }
                    if (!lastScanTime) {
                        lastScanTime = new Date(l3Logs[l3Logs.length - 1].timestamp).getTime();
                    }
                    if (lastScanNode === '-' && pathTrace && pathTrace !== '-') {
                        const nodes = pathTrace.split('->').filter(n => n.trim());
                        if (nodes.length) lastScanNode = nodes[nodes.length - 1].trim();
                    }
                }

                // Final Score = Sum + Manual Bonus
                const manualL3 = parseInt(mData.l3) || 0;

                // --- SIMPLIFIED SCORING SYSTEM ---
                
                // LEVEL 1: Max 10 points
                // Completion-based: 10 points if completed, 0 if not
                let l1Score = 0;
                if (l1Ts) {
                    l1Score = 10; // Max 10 points for Level 1
                }

                // LEVEL 2: Max 10 points but -2 on incorrect
                // Base 10 points, minus 2 per failed attempt
                let l2Score = 0;
                if (l2Success) {
                    l2Score = 10 - (l2Fails * 2); // 10 - (fails √ó 2)
                    if (l2Score < 0) l2Score = 0; // Minimum 0 points
                }

                // LEVEL 3: Based on weighted edges sum
                // Direct score from totalMarks (weighted edges)
                let l3Score = 0;
                if (l3TotalWeight > 0 || l3Logs.length > 0) {
                    l3Score = l3TotalWeight; // Direct score from weighted edges sum
                } else {
                    l3Score = manualL3; // Use manual override if no auto score
                }

                return {
                    ...crew,
                    isLoggedIn,
                    deviceCount: state.liveDevices[id] ? state.liveDevices[id].ids.size : 0,
                    lastActiveAt: state.liveDevices[id] ? state.liveDevices[id].lastSeen : 0,
                    l1Timestamp: l1Ts,
                    l1Score: Math.round(l1Score * 10) / 10,
                    l2Success,
                    l2Fails,
                    l2Score: Math.round(l2Score * 10) / 10,
                    l3Score: Math.round(l3Score * 10) / 10,
                    l3ScanCount: session.scanCount || l3Logs.length,
                    l3TotalWeight,
                    l3AvgScore: Math.round(l3AvgScore * 100) / 100,
                    manualL3,
                    lastScanTime,
                    lastScanNode,
                    pathTrace,
                    l2CompletionTime: l2time,
                    totalScore: Math.round((l1Score + l2Score + l3Score) * 10) / 10
                };
            }).sort((a, b) => b.totalScore - a.totalScore);
        }

        function updateStats() {
            if (state.leaderboard.length > 0) {
                document.getElementById('topCrew').innerText = 
            document.getElementById('activeTeams').innerText = state.leaderboard.filter(c => c.isLoggedIn).length;
        }

        // --- RENDERING ---
        // --- RENDERING ---
        function renderCurrentView() {
            const container = document.getElementById('viewContainer');
            const search = document.getElementById('searchInput').value.toLowerCase();
            const tab = state.currentTab;

            // 1. Initial Data
            let data = state.leaderboard;

            // 2. Search Filter
            if (search) {
                data = data.filter(c =>
                    c.crewname.toLowerCase().includes(search) ||
                    c.crewid.toLowerCase().includes(search)
                );
            }

            // 3. Tab-Specific Filters & Sorting
            if (tab === 'l1') {
                // LEVEL 1: SHOW ALL + SORT BY TIME ASCENDING
                data.sort((a, b) => {
                    // If both have timestamps, compare strings (HH:MM format works for sorting if 24h, 
                    // but input type="time" stores 24h format e.g. "13:15", so string comparison is valid)
                    if (a.l1Timestamp && b.l1Timestamp) {
                        return a.l1Timestamp.localeCompare(b.l1Timestamp);
                    }
                    // If only 'a' has time, it comes first (-1)
                    if (a.l1Timestamp) return -1;
                    // If only 'b' has time, it comes first (1)
                    if (b.l1Timestamp) return 1;
                    // If neither, keep original order (or sort by ID reliably)
                    return a.crewid.localeCompare(b.crewid);
                });
            }
            else if (tab === 'l2') {
                // LEVEL 2: SHOW ALL
            }
            else if (tab === 'l3') {
                // LEVEL 3: SHOW ALL
            }
            else if (tab === 'login') {
                // Show only if logged in
                data = data.filter(c => c.isLoggedIn);
            }

            // Helpers
            const header = (cols, ...titles) => `
                <div class="sticky top-0 z-10 grid gap-4 items-center px-6 py-3 bg-slate-900/90 border-b border-slate-700 text-xs font-bold text-slate-500 uppercase tracking-widest font-mono" style="grid-template-columns: ${cols}">
                    ${titles.map(t => `<div>${t}</div>`).join('')}
                </div>
            `;

            const row = (cols, content) => `
                <div class="grid gap-4 items-center px-6 py-4 border-b border-slate-800 hover:bg-white/5 transition-colors text-sm" style="grid-template-columns: ${cols}">
                    ${content}
                </div>
            `;

            // Empty State
            if (data.length === 0 && tab !== 'leaderboard') {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center p-12 text-slate-600 opacity-50">
                        <div class="text-4xl mb-4">üö´</div>
                        <div class="font-mono text-xs">NO ACTIVE ENTRIES</div>
                        <div class="text-[10px] mt-2">Use input above to add data.</div>
                    </div>`;
                return;
            }

            // RENDER LOGIC
            let html = '';

            // Wrapper start for horizontal scroll on mobile
            const wrapperStart = '<div style="min-width: 900px;">'; // Force min width for tables
            const wrapperEnd = '</div>';

            if (tab === 'leaderboard') {
                html = wrapperStart + header('0.4fr 2fr 1.2fr 1.2fr 1.2fr 1fr', '#', 'CREW', 'L1 (100)', 'L2 (200)', 'L3 (500)', 'TOTAL');
                html += '<div class="divide-y divide-slate-800">';
                html += data.map((d, i) => {
                    // Rank badge colors
                    const rankColor = i === 0 ? 'text-amber-400' : i === 1 ? 'text-slate-300' : i === 2 ? 'text-orange-400' : 'text-slate-600';
                    const rankBg = i < 3 ? 'bg-amber-500/10' : '';

                    return row('0.4fr 2fr 1.2fr 1.2fr 1.2fr 1fr', `
                    <div class="font-mono font-bold ${rankColor}">#${i + 1}</div>
                    <div>
                        <div class="font-bold text-white">${d.crewname}</div>
                        <div class="text-[10px] text-blue-400 font-mono">${d.crewid}</div>
                    </div>
                    <div>
                        <div class="font-mono font-bold ${d.l1Score > 0 ? 'text-green-400' : 'text-slate-600'}">${d.l1Score > 0 ? d.l1Score : '-'}</div>
                        ${d.l1Timestamp ? `<div class="text-[9px] text-slate-500">${d.l1Timestamp}</div>` : ''}
                    </div>
                    <div>
                        <div class="font-mono font-bold ${d.l2Score > 0 ? 'text-green-400' : 'text-slate-600'}">${d.l2Score > 0 ? d.l2Score : '-'}</div>
                        ${d.l2Fails > 0 ? `<div class="text-[9px] text-red-400">${d.l2Fails} fail${d.l2Fails > 1 ? 's' : ''}</div>` : ''}
                        ${d.l2Success ? `<div class="text-[9px] text-green-500">‚úì done</div>` : ''}
                    </div>
                    <div>
                        <div class="font-mono font-bold ${d.l3Score > 0 ? 'text-blue-400' : 'text-slate-600'}">${d.l3Score > 0 ? d.l3Score : '-'}</div>
                        ${d.l3TotalWeight > 0 ? `<div class="text-[9px] text-slate-500">wt: ${d.l3TotalWeight}</div>` : ''}
                    </div>
                    <div class="font-mono font-bold text-amber-400 text-lg ${rankBg} rounded px-1">${d.totalScore}</div>
                `);
                }).join('');
                html += '</div>' + wrapperEnd;

            } else if (state.currentTab === 'login') {
                // LEVEL 0: TEAM STATUS
                html = wrapperStart + header('1fr 2fr 1fr', 'TEAM ID', 'TEAM NAME', 'STATUS');
                html += data.map(d => {
                    const status = d.isLoggedIn
                        ? '<span class="px-2 py-1 rounded bg-green-500/20 text-green-400 text-xs font-bold border border-green-500/30">ONLINE</span>'
                        : '<span class="px-2 py-1 rounded bg-slate-800 text-slate-500 text-xs font-bold border border-slate-700">OFFLINE</span>';

                    return row('1fr 2fr 1fr', `
                        <div class="font-mono text-blue-400 font-bold">${d.crewid}</div>
                        <div class="text-white">${d.crewname}</div>
                        <div>${status}</div>
                    `);
                }).join('') + wrapperEnd;

            } else if (state.currentTab === 'l1') {
                // LEVEL 1: MANUAL TIMESTAMP ENTRY + MARKS
                html = wrapperStart + header('1fr 2fr 1fr 2fr 1fr 1fr', 'TEAM ID', 'TEAM NAME', 'STATUS', 'TIMESTAMP', 'MARKS', 'ACTION');
                html += data.map(d => {
                    const status = d.isLoggedIn
                        ? '<span class="px-2 py-0.5 rounded bg-green-500/20 text-green-400 text-[10px] font-bold border border-green-500/30">ONLINE</span>'
                        : '<span class="px-2 py-0.5 rounded bg-slate-800 text-slate-500 text-[10px] font-bold border border-slate-700">OFFLINE</span>';

                    return row('1fr 2fr 1fr 2fr 1fr 1fr', `
                        <div class="font-mono text-blue-400">${d.crewid}</div>
                        <div class="text-white flex flex-col">
                            <span>${d.crewname}</span>
                        </div>
                        <div>${status}</div>
                        <input type="text" id="ts_${d.crewid}" value="${d.l1Timestamp || ''}" placeholder="HH:MM" onblur="formatTimeInput(this)" class="bg-slate-900 border border-slate-700 rounded text-xs px-2 py-1 text-white w-full font-mono text-center tracking-wider">
                        <div class="font-mono font-bold ${d.l1Score > 0 ? 'text-green-400' : 'text-slate-600'}">
                            ${d.l1Score > 0 ? '10' : '0'}
                        </div>
                        <button onclick="saveL1('${d.crewid}')" class="bg-blue-600 hover:bg-blue-500 text-white text-[10px] px-3 py-1.5 rounded font-bold transition-all uppercase">SAVE</button>
                    `);
                }).join('') + wrapperEnd;


            } else if (state.currentTab === 'l2') {
                // LEVEL 2: QUIZ SUBMISSION TRACKING (Automatic)
                html = wrapperStart + header('1fr 2fr 1fr 2fr 1fr 1fr', 'CREW ID', 'CREW NAME', 'STATUS', 'COMPLETION TIME (AUTO)', 'FAILURES', 'SCORE');
                html += data.map(d => {
                    const timestamp = d.l2CompletionTime !== '-' ? d.l2CompletionTime : '-';
                    const status = d.isLoggedIn
                        ? '<span class="px-2 py-0.5 rounded bg-green-500/20 text-green-400 text-[10px] font-bold border border-green-500/30">ONLINE</span>'
                        : '<span class="px-2 py-0.5 rounded bg-slate-800 text-slate-500 text-[10px] font-bold border border-slate-700">OFFLINE</span>';

                    return row('1fr 2fr 1fr 2fr 1fr 1fr', `
                        <div class="font-mono text-blue-400">${d.crewid}</div>
                        <div class="text-white flex flex-col">
                            <span>${d.crewname}</span>
                        </div>
                        <div>${status}</div>
                        <div class="font-mono text-xs ${d.l2Success ? 'text-green-400' : 'text-slate-500'}">
                            ${timestamp}
                        </div>
                        <div class="font-mono text-slate-300 text-center">${d.l2Fails}</div>
                        <div class="font-mono font-bold text-amber-400 text-lg text-center">${d.l2Score}</div>
                    `);
                }).join('') + wrapperEnd;

            } else if (state.currentTab === 'l3') {
                // LEVEL 3: QR NODE SCANNING - ROSTER LOG
                html = wrapperStart + header('0.8fr 1fr 1.5fr 2fr 0.8fr 0.8fr 0.9fr 1.2fr 1fr', 'STATUS', 'CREW ID', 'CREW NAME', 'PATH', 'LAST SCAN', 'SCANS', 'AVG', 'TIMESTAMP', 'MARKS');
                html += data.map(d => {
                    const pathTrace = d.pathTrace || '-';
                    const marks = d.l3TotalWeight || 0;
                    const scans = d.l3ScanCount || 0;
                    const avg = d.l3AvgScore || 0;
                    const timestamp = d.lastScanTime ? new Date(d.lastScanTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '-';

                    let lastNode = d.lastScanNode || '-';
                    if ((lastNode === '-' || !lastNode) && pathTrace && pathTrace !== '-') {
                        const nodes = pathTrace.split('->').filter(n => n.trim());
                        lastNode = nodes.length > 0 ? nodes[nodes.length - 1].trim() : '-';
                    }

                    const statusText = d.isLoggedIn ? 'ONLINE' : 'OFFLINE';
                    const statusClass = d.isLoggedIn
                        ? 'bg-green-500/20 text-green-400 border-green-500/30'
                        : 'bg-red-500/20 text-red-400 border-red-500/30';

                    return row('0.8fr 1fr 1.5fr 2fr 0.8fr 0.8fr 0.9fr 1.2fr 1fr', `
                        <div><span class="px-2 py-0.5 rounded text-[10px] font-bold border ${statusClass}">${statusText}</span></div>
                        <div class="font-mono text-blue-400 font-bold">${d.crewid}</div>
                        <div class="text-white font-semibold">${d.crewname}</div>
                        <div class="font-mono text-slate-300 text-[10px] break-all leading-tight">${escapeHTML(pathTrace)}</div>
                        <div class="font-mono text-cyan-400 font-bold text-sm text-center">${escapeHTML(lastNode)}</div>
                        <div class="font-mono text-slate-300 text-sm text-center">${scans}</div>
                        <div class="font-mono text-amber-300 text-sm text-center">${avg}</div>
                        <div class="font-mono text-slate-400 text-xs text-center">${timestamp}</div>
                        <div class="font-mono font-bold text-green-400 text-lg text-center">${marks}</div>
                    `);
                }).join('') + wrapperEnd;

            } else if (tab === 'timer') {
                const timerState = JSON.parse(localStorage.getItem('pirate_timer_state') || '{}');
                const lastUpdated = timerState.timestamp ? new Date(timerState.timestamp).toLocaleTimeString() : 'NEVER';

                html = `
                    <div class="p-8 max-w-4xl mx-auto space-y-8 fade-in">
                        <div class="glass-panel p-6 rounded-2xl border-l-4 border-blue-500 bg-blue-500/5">
                            <div class="flex justify-between items-center mb-6">
                                <div>
                                    <h3 class="text-lg font-bold text-white">Live Monitor</h3>
                                    <p class="text-xs text-slate-500">Real-time status of the global timer node</p>
                                </div>
                                <div class="text-right">
                                    <div class="text-[10px] text-slate-500 uppercase font-mono">Status</div>
                                    <div class="text-sm font-bold ${timerState.isRunning ? 'text-green-400' : 'text-amber-400'} font-mono">
                                        ${timerState.isRunning ? '‚óè ACTIVE' : '‚óã PAUSED/IDLE'}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-center gap-6 py-4 bg-black/40 rounded-xl border border-slate-800">
                                <div class="text-6xl font-mono font-bold text-white tracking-tighter">
                                    ${formatSeconds(timerState.remaining || 0)}
                                </div>
                            </div>
                            <div class="mt-4 text-[10px] text-slate-600 font-mono text-center">
                                LAST SIGNAL: ${lastUpdated}
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="glass-panel p-6 rounded-2xl border-t-2 border-slate-700">
                                <h4 class="text-xs font-bold text-slate-500 uppercase mb-4 tracking-widest">Initialization</h4>
                                <div class="flex gap-2 mb-4">
                                    <input type="number" id="remote-m" placeholder="Min" class="w-full bg-black/40 border border-slate-800 rounded px-3 py-2 text-white font-mono">
                                    <input type="number" id="remote-s" placeholder="Sec" class="w-full bg-black/40 border border-slate-800 rounded px-3 py-2 text-white font-mono">
                                </div>
                                <button onclick="sendRemoteCommand('INIT', { m: document.getElementById('remote-m').value, s: document.getElementById('remote-s').value })" 
                                    class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg transition-all text-sm uppercase tracking-wider shadow-lg shadow-blue-900/20">
                                    SET & BROADCAST
                                </button>
                            </div>

                            <div class="glass-panel p-6 rounded-2xl border-t-2 border-slate-700">
                                <h4 class="text-xs font-bold text-slate-500 uppercase mb-4 tracking-widest">Playback Controls</h4>
                                <div class="grid grid-cols-2 gap-3">
                                    <button onclick="sendRemoteCommand('TOGGLE')" class="py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg transition-all text-xs uppercase">
                                        START/PAUSE
                                    </button>
                                    <button onclick="sendRemoteCommand('RESET')" class="py-3 bg-red-900/40 border border-red-500/50 text-red-400 hover:bg-red-500 hover:text-white font-bold rounded-lg transition-all text-xs uppercase">
                                        HARD RESET
                                    </button>
                                </div>
                                <div class="mt-4 flex gap-2">
                                    <button onclick="sendRemoteCommand('ADJUST', { delta: 30 })" class="flex-1 py-1.5 bg-slate-800 hover:bg-slate-700 text-green-400 text-[10px] font-bold rounded border border-slate-700 transition-all">+30s</button>
                                    <button onclick="sendRemoteCommand('ADJUST', { delta: -30 })" class="flex-1 py-1.5 bg-slate-800 hover:bg-slate-700 text-red-400 text-[10px] font-bold rounded border border-slate-700 transition-all">-30s</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (state.currentTab === 'roster') {
                // ROSTER: FULL CREW DETAILS
                html = wrapperStart + header('0.8fr 1.5fr 1.3fr 0.8fr 1.1fr 1fr 2fr', 'CREW ID', 'CREW NAME', 'CAPTAIN', 'PHONES', 'LAST ACTIVE', 'PASSWORD', 'MEMBERS');
                html += state.crews.map(c => {
                    const crewStats = state.leaderboard.find(x => x.crewid === c.crewid) || {};
                    const phones = crewStats.deviceCount || 0;
                    const lastActive = crewStats.lastActiveAt ? new Date(crewStats.lastActiveAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' }) : '-';
                    const members = Array.isArray(c.members) ? c.members.join(', ') : c.members;
                    return row('0.8fr 1.5fr 1.3fr 0.8fr 1.1fr 1fr 2fr', `
                        <div class="font-mono text-blue-400 font-bold">${c.crewid}</div>
                        <div class="text-white">${c.crewname}</div>
                        <div class="text-amber-400 text-xs">${c.captain}</div>
                        <div class="font-mono text-cyan-400 font-bold">${phones}</div>
                        <div class="font-mono text-slate-300 text-xs">${lastActive}</div>
                        <div class="font-mono text-red-400 font-bold tracking-wider">${c.password}</div>
                        <div class="text-slate-400 text-xs break-words">${members}</div>
                    `);
                }).join('') + wrapperEnd;
            } else if (state.currentTab === 'settings') {
                const sheetUrl = getSheetUrl();
                html = `
                    <div class="p-8 max-w-2xl mx-auto space-y-8 fade-in">
                        <div class="glass-panel p-6 rounded-2xl border-t-2 border-green-500">
                            <h3 class="text-lg font-bold text-white mb-2 flex items-center gap-2">
                                <span class="text-xl">üìä</span> Google Sheets Database (Backup)
                            </h3>
                            <p class="text-xs text-slate-400 mb-6 leading-relaxed">
                                Link your admin panel to a Google Sheet via Apps Script. This maintains a three-tier clean real-time backup.
                            </p>
                            
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Apps Script Deployment URL</label>
                            <div class="flex gap-2 mb-4">
                                <input type="text" id="sheetUrlInput" value="${sheetUrl}" 
                                    placeholder="https://script.google.com/macros/s/.../exec"
                                    class="flex-1 bg-black/40 border border-slate-700 rounded-lg text-xs text-white px-4 py-3 focus:border-green-500 outline-none transition-all">
                                <button onclick="saveSheetSettings()" 
                                    class="px-6 bg-green-600 hover:bg-green-500 text-white text-xs font-bold rounded-lg transition-all shadow-lg shadow-green-900/20">
                                    SAVE
                                </button>
                            </div>
                            
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Access Google Sheet</label>
                            <button onclick="window.open('https://docs.google.com/spreadsheets/d/17V6tx_JYPBQiQcsYWINs5cNtHd1PUgV9WnG4oHiLDCc/edit', '_blank')" 
                                class="w-full py-3 bg-amber-600 hover:bg-amber-500 text-white font-bold rounded-lg transition-all text-sm uppercase tracking-wider shadow-lg shadow-amber-900/20 flex items-center justify-center gap-2">
                                <span>üìä</span> OPEN GOOGLE SHEET
                            </button>
                        </div>

                        <div class="glass-panel p-6 rounded-2xl border-t-2 border-blue-500">
                            <h3 class="text-lg font-bold text-white mb-4">Manual Control Center</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <button onclick="syncToSheets()" class="p-4 bg-slate-800/50 border border-slate-700 rounded-xl hover:bg-slate-800 transition-all text-left">
                                    <div class="text-xs font-bold text-blue-400 uppercase mb-1">Global Sync</div>
                                    <div class="text-[10px] text-slate-500">Force immediate sync of all 3 tiers to cloud.</div>
                                </button>
                                <button onclick="testCloudConnection()" class="p-4 bg-emerald-900/20 border border-emerald-500/50 rounded-xl hover:bg-emerald-600/30 transition-all text-left">
                                    <div class="text-xs font-bold text-emerald-400 uppercase mb-1">Cloud Test</div>
                                    <div class="text-[10px] text-slate-500">Checks endpoint reachability and sends a probe event.</div>
                                </button>
                                <button onclick="resetFullGame()" class="p-4 bg-red-900/20 border border-red-500/50 rounded-xl hover:bg-red-600/40 transition-all text-left group">
                                    <div class="text-xs font-bold text-red-500 group-hover:text-white uppercase mb-1">üî• GLOBAL ZERO RESET</div>
                                    <div class="text-[10px] text-red-400/70 group-hover:text-red-200">WIPE EVERYTHING. Cloud + Local. Irreversible.</div>
                                </button>
                            </div>
                        </div>

                        <div class="glass-panel p-6 rounded-2xl border-t-2 border-amber-500">
                            <h3 class="text-lg font-bold text-white mb-2 flex items-center gap-2">
                                <span class="text-xl">üîÑ</span> Level-Wise Reset
                            </h3>
                            <p class="text-xs text-slate-400 mb-6 leading-relaxed">
                                Reset individual levels between rounds. Only clears that level's data ‚Äî other levels stay intact.
                            </p>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <button onclick="resetLevel(1)" class="p-4 bg-amber-900/20 border border-amber-500/40 rounded-xl hover:bg-amber-600/30 transition-all text-center group">
                                    <div class="text-2xl mb-2">‚öì</div>
                                    <div class="text-sm font-bold text-amber-400 group-hover:text-amber-300 uppercase">Reset L1</div>
                                    <div class="text-[10px] text-slate-500 mt-1">Clears all timestamps</div>
                                </button>
                                <button onclick="resetLevel(2)" class="p-4 bg-blue-900/20 border border-blue-500/40 rounded-xl hover:bg-blue-600/30 transition-all text-center group">
                                    <div class="text-2xl mb-2">üß©</div>
                                    <div class="text-sm font-bold text-blue-400 group-hover:text-blue-300 uppercase">Reset L2</div>
                                    <div class="text-[10px] text-slate-500 mt-1">Clears quiz results</div>
                                </button>
                                <button onclick="resetLevel(3)" class="p-4 bg-purple-900/20 border border-purple-500/40 rounded-xl hover:bg-purple-600/30 transition-all text-center group">
                                    <div class="text-2xl mb-2">üó∫Ô∏è</div>
                                    <div class="text-sm font-bold text-purple-400 group-hover:text-purple-300 uppercase">Reset L3</div>
                                    <div class="text-[10px] text-slate-500 mt-1">Clears paths & scans</div>
                                </button>
                            </div>
                            <button onclick="resetAllLevels()" class="w-full mt-4 p-3 bg-red-900/30 border border-red-500/40 rounded-xl hover:bg-red-600/40 transition-all text-center group">
                                <div class="text-xs font-bold text-red-400 group-hover:text-white uppercase">RESET ALL 3 LEVELS (Keep Logins)</div>
                                <div class="text-[10px] text-slate-500 mt-1">Resets L1 + L2 + L3 but keeps login status & crew data</div>
                            </button>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function saveSheetSettings() {
            const url = document.getElementById('sheetUrlInput').value.trim();
            localStorage.setItem('google_sheet_url', url);
            alert("Settings Saved!");
            refreshData();
        }

        function openGoogleSheet() {
            // Extract sheet ID from Google Apps Script URL
            const endpoint = getSheetUrl();

            // Prompt user to enter Google Sheet ID or open in new window
            const sheetId = prompt("Enter your Google Sheet ID (found in the sheet URL after '/d/')\nOr leave blank to visit Google Sheets:", "");
            if (sheetId) {
                window.open(`https://docs.google.com/spreadsheets/d/${sheetId}/`, '_blank');
            } else {
                window.open('https://docs.google.com/spreadsheets/', '_blank');
            }
        }

        async function pullFromSheets() {
            const endpoint = getSheetUrl();

            const btn = document.getElementById('pullBtn');
            const icon = document.getElementById('pullIcon');
            if (btn) btn.disabled = true;
            if (icon) icon.classList.add('animate-spin');

            try {
                const response = await fetch(endpoint);
                const cloudData = await response.json();

                if (cloudData.logs) {
                    const localLogs = state.logs;
                    // Merge logs, avoiding duplicates if possible (simplistic timestamp + type match)
                    const mergedLogs = [...localLogs];
                    cloudData.logs.forEach(cl => {
                        const raw = JSON.parse(cl.Raw || '{}');
                        if (!mergedLogs.find(ml => ml.timestamp === raw.timestamp && ml.type === raw.type)) {
                            mergedLogs.push(raw);
                        }
                    });
                    state.logs = mergedLogs.sort((a, b) => b.timestamp - a.timestamp);
                    localStorage.setItem(KEYS.LOGS, JSON.stringify(state.logs));
                }

                if (cloudData.leaderboard) {
                    // Update manual overrides based on cloud standing
                    cloudData.leaderboard.forEach(c => {
                        if (!state.manual[c.CrewID]) state.manual[c.CrewID] = {};
                        if (c.Status === 'LEVEL_2_CERTIFIED') state.manual[c.CrewID].l2 = { complete: true, fails: 0 };
                        if (c.Status === 'LEVEL_3_RACE') state.manual[c.CrewID].l3_started = true;
                    });
                    localStorage.setItem(KEYS.MANUAL, JSON.stringify(state.manual));
                }

                alert("CLOUD RECOVERY SUCCESSFUL!\nMerged logs and standings from Google Sheets.");
                refreshData();
            } catch (e) {
                console.error(e);
                alert("PULL FAILED: Check script deployment and CORS.");
            } finally {
                if (btn) btn.disabled = false;
                if (icon) icon.classList.remove('animate-spin');
            }
        }

        async function syncToSheets() {
            const endpoint = getSheetUrl();

            const btn = document.getElementById('syncBtn');
            const icon = document.getElementById('syncIcon');
            if (btn) btn.disabled = true;
            if (icon) icon.classList.add('animate-spin');

            try {
                // TIER 1: Leaderboard (Rankings)
                const leaderboardData = state.leaderboard.map((d, i) => ({
                    Rank: i + 1,
                    CrewID: d.crewid,
                    Name: d.crewname,
                    Status: d.l3TotalWeight > 0 ? 'LEVEL_3_RACE' : (d.l2Success ? 'LEVEL_2_CERTIFIED' : 'ACTIVE'),
                    Score_L1: d.l1Timestamp || '-',
                    Score_L2: d.l2Score,
                    Score_L3: d.l3TotalWeight || 0,
                    Avg_Score: d.l3AvgScore || 0,
                    Total_Points: d.totalScore.toFixed(2),
                    Last_Seen: d.l1Timestamp || '-',
                    Last_Scan: d.lastScanNode || '-',
                    Last_Scan_Time: d.lastScanTime ? new Date(d.lastScanTime).toLocaleTimeString() : '-',
                    Path_Trace: d.pathTrace || '-',
                    Scan_Count: d.l3ScanCount || 0,
                    Device_ID: d.deviceId || ''
                }));

                // TIER 2: Path Analytics (L3 Specific)
                const pathData = state.leaderboard.map(d => {
                    const s = state.l3Sessions[d.crewid] || {};
                    return {
                        CrewID: d.crewid,
                        Name: d.crewname,
                        Path: s.pathTrace || d.pathTrace || '-',
                        Scans: s.scanCount || d.l3ScanCount || 0,
                        Internal_Marks: s.totalMarks || d.l3TotalWeight || 0,
                        Avg_Score: (s.avgScore || 0).toFixed(2),
                        Last_Scan: s.lastScanNode || d.lastScanNode || '-',
                        Last_Scan_Time: s.lastScanTime ? new Date(s.lastScanTime).toLocaleTimeString() : '-'
                    };
                });

                // TIER 3: Raw Action Logs
                const logData = state.logs.slice(-50).map(l => ({
                    Timestamp: new Date(l.timestamp).toLocaleString(),
                    Type: l.type,
                    Category: l.crewId,
                    Device_ID: l.deviceId || '',
                    Session_ID: l.sessionId || '',
                    Page: l.page || '',
                    Raw: JSON.stringify(l)
                }));

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'BULK_SYNC',
                        tier1: leaderboardData,
                        tier2: pathData,
                        tier3: logData,
                    })
                });

                const text = await response.text();
                console.log("Sync response:", text);
                
                alert("‚úÖ Sync complete!");
                await refreshData(); // Refresh to get latest
            } catch (e) {
                console.error(e);
                alert("‚ùå Sync failed: " + e.message);
            } finally {
                if (btn) btn.disabled = false;
                if (icon) icon.classList.remove('animate-spin');
            }
        }

        // --- UTILS ---
        function formatSeconds(s) {
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60);
            const sec = s % 60;
            return `${h > 0 ? h.toString().padStart(2, '0') + ':' : ''}${m.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
        }

        function sendRemoteCommand(action, data = {}) {
            const cmd = {
                action,
                data,
                id: Date.now(),
                timestamp: Date.now()
            };
            localStorage.setItem('pirate_timer_command', JSON.stringify(cmd));
            setTimeout(refreshData, 100);
        }

        async function testCloudConnection() {
            const endpoint = getSheetUrl();
            console.log("Testing connection to:", endpoint);
            
            try {
                const response = await fetch(endpoint, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                
                const text = await response.text();
                console.log("Raw response:", text.substring(0, 200));
                
                try {
                    const data = JSON.parse(text);
                    console.log("Parsed data:", data);
                    alert(`‚úÖ Connection OK!\nLeaderboard: ${data.leaderboard?.length || 0} entries\nLogs: ${data.logs?.length || 0}`);
                } catch (e) {
                    alert("‚ùå Response is not valid JSON. Check your Apps Script deployment.");
                }
            } catch (e) {
                console.error("Connection test failed:", e);
                alert("‚ùå Connection failed: " + e.message);
            }
        }

        function clearClientPathState() {
            try {
                const rawState = localStorage.getItem('pirateState');
                if (!rawState) return;

                const pirateState = JSON.parse(rawState);
                if (!pirateState || typeof pirateState !== 'object') return;

                pirateState.journey = [];
                pirateState.jumps = [];
                pirateState.level3Session = null;
                pirateState.currentNode = 'START';
                pirateState.targetNode = null;

                localStorage.setItem('pirateState', JSON.stringify(pirateState));
            } catch (e) {
                console.warn('Failed to clear client path state:', e);
            }
        }


        function addManualLogin() {
            const id = document.getElementById('manualLoginId').value.toUpperCase();
            if (!id) return alert("Enter Crew ID");
            if (!state.crews.find(c => c.crewid === id)) return alert("Invalid Crew ID");

            if (!state.manual[id]) state.manual[id] = {};
            state.manual[id].login = true;
            saveManual();
            document.getElementById('manualLoginId').value = '';
        }

        function addManualL2() {
            const id = document.getElementById('manualL2Id').value.toUpperCase();
            const status = document.getElementById('manualL2Status').value;
            const fails = document.getElementById('manualL2Fails').value;

            if (!id) return alert("Enter Crew ID");
            if (!state.crews.find(c => c.crewid === id)) return alert("Invalid Crew ID");

            if (!state.manual[id]) state.manual[id] = {};
            state.manual[id].l2 = {
                complete: status === 'complete',
                fails: fails === '' ? 0 : parseInt(fails)
            };
            saveManual();

            // Clear inputs
            document.getElementById('manualL2Id').value = '';
            document.getElementById('manualL2Fails').value = '';
        }

        function addManualL3() {
            const id = document.getElementById('manualL3Id').value.toUpperCase();
            const points = document.getElementById('manualL3Points').value;

            if (!id) return alert("Enter Crew ID");
            if (!state.crews.find(c => c.crewid === id)) return alert("Invalid Crew ID");
            if (!points) return alert("Enter Points");

            if (!state.manual[id]) state.manual[id] = {};
            state.manual[id].l3 = parseInt(points);
            saveManual();

            document.getElementById('manualL3Id').value = '';
            document.getElementById('manualL3Points').value = '';
        }

        // --- ROW ACTIONS ---
        function saveManual() { localStorage.setItem(KEYS.MANUAL, JSON.stringify(state.manual)); refreshData(); }
        function saveL1Data() { localStorage.setItem(KEYS.L1, JSON.stringify(state.l1Data)); refreshData(); }

        window.saveL1 = (id) => {
            const val = document.getElementById(`ts_${id}`).value;
            if (val) state.l1Data[id] = val; else delete state.l1Data[id];
            saveL1Data();
            alert("Level 1 Updated");
        };

        // Remove Overrides
        window.toggleLogin = (id, status) => {
            if (!state.manual[id]) state.manual[id] = {};
            state.manual[id].login = status;
            if (!status) delete state.manual[id].login; // actually remove key if false
            saveManual();
        };

        window.saveL2 = (id) => {
            const tsVal = document.getElementById(`l2_ts_${id}`).value.trim();
            const failsVal = document.getElementById(`l2_fails_${id}`).value;

            if (!state.manual[id]) state.manual[id] = {};

            if (tsVal) {
                // UPDATE
                state.manual[id].l2 = {
                    timestamp: tsVal,
                    fails: parseInt(failsVal) || 0
                };
                alert("Level 2 Updated for " + id);
            } else {
                // CLEAR if empty timestamp
                if (state.manual[id].l2) {
                    if (confirm("Clear Level 2 data for " + id + "?")) {
                        delete state.manual[id].l2;
                    } else {
                        return; // Cancelled
                    }
                }
            }
            saveManual();
        };

        window.clearL3 = (id) => {
            if (confirm('Clear Level 3 session data for ' + id + '?')) {
                try {
                    let l3Sessions = JSON.parse(localStorage.getItem('level3_sessions') || '[]');
                    l3Sessions = l3Sessions.filter(s => s.crewId !== id);
                    localStorage.setItem('level3_sessions', JSON.stringify(l3Sessions));
                    refreshData();
                } catch (e) {
                    console.error("Failed to clear L3 session:", e);
                }
            }
        }

        window.exportLogs = (type) => {
            const data = state.logs;
            if (!data.length) return alert("No logs");
            const headers = Object.keys(data[0]);
            const rows = [headers.join(',')];
            data.forEach(r => rows.push(headers.map(h => `"${r[h] || ''}"`).join(',')));

            const blob = new Blob([rows.join('\n')], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pirates_log_${Date.now()}.csv`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        };

        window.clearAllLogs = () => {
            if (confirm("WIPE ALL LOGS?")) {
                localStorage.removeItem(KEYS.LOGS);
                refreshData();
            }
        };

        window.resetFullGame = async () => {
            if (confirm("üö® DANGER: GLOBAL SERVER RESET üö®\n\nThis will PERMANENTLY ERASE ALL GAME DATA:\n- All Player Scores & Progress\n- All Leaderboard Rankings\n- All Logs & History\n- Google Sheets Database\n\nAre you absolutely sure?")) {
                const confirmation = prompt("Type 'DELETE' to confirm full reset:");
                if (confirmation !== 'DELETE') return alert("Reset Cancelled.");

                const endpoint = getSheetUrl();

                // UI Feedback
                const btn = document.querySelector('button[onclick="resetFullGame()"]');
                if (btn) {
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<div class="text-xs font-bold text-white uppercase animate-pulse">Creating New Galaxy...</div>';
                    btn.disabled = true;
                }

                try {
                    // 1. Reset Server
                    await fetch(endpoint, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'RESET_GAME' })
                    });

                    // 2. Clear Local Storage
                    const sheetUrl = localStorage.getItem('google_sheet_url');
                    localStorage.clear();
                    localStorage.setItem('google_sheet_url', sheetUrl);

                    alert("‚úÖ UNIVERSE RESET SUCCESSFUL.\nStarting fresh instance.");
                    window.location.reload();

                } catch (e) {
                    console.error(e);
                    alert("FATAL ERROR: Could not reset server. Check console.");
                    if (btn) {
                        btn.innerHTML = "üî• GLOBAL ZERO RESET";
                        btn.disabled = false;
                    }
                }
            }
        };

        // ===== LEVEL-WISE RESET FUNCTIONS =====
        window.resetLevel = (level) => {
            const levelNames = { 1: 'Level 1 (Timestamps)', 2: 'Level 2 (Quiz Results)', 3: 'Level 3 (Paths & Scans)' };
            if (!confirm(`‚ö†Ô∏è RESET ${levelNames[level]}?\n\nThis will clear all ${levelNames[level]} data for every crew.\nOther levels stay intact.\n\nContinue?`)) return;

            if (level === 1) {
                // Clear L1 timestamps
                state.l1Data = {};
                localStorage.removeItem(KEYS.L1);

                // Clear L1-related manual overrides
                Object.keys(state.manual).forEach(id => {
                    if (state.manual[id]) delete state.manual[id].l1;
                });
                localStorage.setItem(KEYS.MANUAL, JSON.stringify(state.manual));

                // Remove L1-related logs
                state.logs = state.logs.filter(l => !['LEVEL1_COMPLETE', 'L1_SCAN'].includes(l.type));
                localStorage.setItem(KEYS.LOGS, JSON.stringify(state.logs));

                alert('‚úÖ Level 1 Reset Complete!\nAll timestamps cleared.');

            } else if (level === 2) {
                // Clear L2 manual overrides
                Object.keys(state.manual).forEach(id => {
                    if (state.manual[id]) delete state.manual[id].l2;
                });
                localStorage.setItem(KEYS.MANUAL, JSON.stringify(state.manual));

                // Remove L2-related logs (VERIFY events)
                state.logs = state.logs.filter(l => l.type !== 'VERIFY');
                localStorage.setItem(KEYS.LOGS, JSON.stringify(state.logs));

                alert('‚úÖ Level 2 Reset Complete!\nAll quiz results cleared.');

            } else if (level === 3) {
                // Clear L3 sessions
                state.l3Sessions = {};
                localStorage.removeItem('level3_sessions');
                clearClientPathState();

                // Clear L3 manual overrides
                Object.keys(state.manual).forEach(id => {
                    if (state.manual[id]) delete state.manual[id].l3;
                });
                localStorage.setItem(KEYS.MANUAL, JSON.stringify(state.manual));

                // Remove L3-related logs
                state.logs = state.logs.filter(l => !['LEVEL3_SCAN', 'LOCATION'].includes(l.type));
                localStorage.setItem(KEYS.LOGS, JSON.stringify(state.logs));

                alert('‚úÖ Level 3 Reset Complete!\nAll paths, scans & sessions cleared.');
            }

            // Sync the cleaned state to Google Sheets
            syncToSheets();
            refreshData();
        };

        window.resetAllLevels = () => {
            if (!confirm('‚ö†Ô∏è RESET ALL 3 LEVELS?\n\nThis will clear L1 timestamps, L2 quiz results, and L3 paths/scans.\nLogin status & crew data will be kept.\n\nContinue?')) return;

            const confirmation = prompt("Type 'RESET' to confirm:");
            if (confirmation !== 'RESET') return alert('Cancelled.');

            // L1
            state.l1Data = {};
            localStorage.removeItem(KEYS.L1);

            // L2 + L3 manual overrides
            Object.keys(state.manual).forEach(id => {
                if (state.manual[id]) {
                    delete state.manual[id].l1;
                    delete state.manual[id].l2;
                    delete state.manual[id].l3;
                }
            });
            localStorage.setItem(KEYS.MANUAL, JSON.stringify(state.manual));

            // L3 sessions
            state.l3Sessions = {};
            localStorage.removeItem('level3_sessions');
            clearClientPathState();

            // Clear level-specific logs but keep LOGIN logs
            state.logs = state.logs.filter(l => l.type === 'LOGIN');
            localStorage.setItem(KEYS.LOGS, JSON.stringify(state.logs));

            alert('‚úÖ All 3 Levels Reset!\nLogin status preserved. Ready for next round.');
            syncToSheets();
            refreshData();
        };

        window.clearEverything = () => {
            if (confirm("‚ö†Ô∏è DANGER ZONE: This will wipe ALL local data on this device (Logs, Manual Overrides, cached Roster). \n\nIt does NOT delete data from the Google Sheet.\n\nAre you sure?")) {
                const sheetUrl = localStorage.getItem('google_sheet_url'); // Preserve Sheet URL
                localStorage.clear();
                if (sheetUrl) localStorage.setItem('google_sheet_url', sheetUrl);
                alert("System Wiped. Reloading...");
                window.location.reload();
            }
        };

        // --- HELPER: TIME FORMATTER ---
        window.formatTimeInput = (input) => {
            let val = input.value.trim();
            if (!val) return;

            // Remove all non-digits to handle 12:30, 12.30, 12 30, 1230
            const digits = val.replace(/[^0-9]/g, '');
            let h = 0, m = 0;

            if (val.includes(':') || val.includes('.') || val.includes(' ')) {
                // Separator logic
                const parts = val.split(/[:. ]/);
                h = parseInt(parts[0] || '0');
                m = parseInt(parts[1] || '0');
            } else if (digits.length === 4) {
                // e.g. 1230
                h = parseInt(digits.substring(0, 2));
                m = parseInt(digits.substring(2, 4));
            } else if (digits.length === 3) {
                // e.g. 930 -> 09:30
                h = parseInt(digits.substring(0, 1));
                m = parseInt(digits.substring(1, 3));
            } else if (digits.length <= 2) {
                // e.g. 9 -> 09:00, 12 -> 12:00
                h = parseInt(digits);
                m = 0;
            }

            // Validate
            if (isNaN(h) || h < 0 || h > 23) {
                // Try visual feedback
                input.style.borderColor = 'red';
                return;
            }
            if (isNaN(m) || m < 0 || m > 59) m = 0;

            // Format HH:MM
            const hh = h.toString().padStart(2, '0');
            const mm = m.toString().padStart(2, '0');
            input.value = `${hh}:${mm}`;
            input.style.borderColor = ''; // Reset
        };

        // --- HELPER FUNCTIONS FOR DATA PROCESSING ---
        function processLeaderboardData(leaderboard) {
            if (!leaderboard || !Array.isArray(leaderboard)) return;
            
            leaderboard.forEach(row => {
                const crewId = row.CrewID;
                if (!crewId) return;
                
                // L1 timestamp
                if (row.Score_L1 && row.Score_L1 !== '-') {
                    state.l1Data[crewId] = row.Score_L1;
                }
                
                // L2 status
                const l2Complete = row.Status === 'LEVEL_2_CERTIFIED' || 
                                row.Status === 'LEVEL_3_RACE' ||
                                row.Score_L2 === 'COMPLETE';
                
                if (l2Complete) {
                    if (!state.manual[crewId]) state.manual[crewId] = {};
                    if (!state.manual[crewId].l2) {
                        state.manual[crewId].l2 = { 
                            timestamp: row.Last_Seen || '-', 
                            fails: 0 
                        };
                    }
                }
                
                // L3 data
                const l3Marks = parseFloat(row.Score_L3) || 0;
                if (l3Marks > 0 || row.Path_Trace !== '-') {
                    state.l3Sessions[crewId] = {
                        crewId: crewId,
                        totalMarks: l3Marks,
                        pathTrace: row.Path_Trace || '-',
                        scanCount: parseInt(row.Scan_Count) || 0,
                        lastScanNode: row.Last_Scan || '-',
                        lastScanTime: row.Last_Scan_Time ? Date.parse(row.Last_Scan_Time) || 0 : 0,
                        avgScore: parseFloat(row.Avg_Score) || 0
                    };
                }
                
                // Track live devices
                if (row.Device_ID) {
                    touchLiveDevice(crewId, row.Device_ID, row.Last_Seen);
                }
            });
        }

        function processPathData(paths) {
            if (!paths || !Array.isArray(paths)) return;
            
            paths.forEach(row => {
                const crewId = row.CrewID;
                if (!crewId) return;
                
                const existing = state.l3Sessions[crewId] || { crewId };
                state.l3Sessions[crewId] = {
                    ...existing,
                    totalMarks: parseInt(row.Internal_Marks) || existing.totalMarks || 0,
                    pathTrace: row.Path || existing.pathTrace || '-',
                    scanCount: parseInt(row.Scans) || existing.scanCount || 0,
                    lastScanNode: row.Last_Scan || existing.lastScanNode || '-',
                    lastScanTime: row.Last_Scan_Time ? Date.parse(row.Last_Scan_Time) || 0 : (existing.lastScanTime || 0),
                    avgScore: parseFloat(row.Avg_Score) || existing.avgScore || 0
                };
            });
        }

        function loadFromLocalStorage() {
            try {
                state.logs = JSON.parse(localStorage.getItem(KEYS.LOGS) || '[]');
                state.l1Data = JSON.parse(localStorage.getItem(KEYS.L1) || '{}');
                state.manual = JSON.parse(localStorage.getItem(KEYS.MANUAL) || '{}');
                
                const l3All = JSON.parse(localStorage.getItem('level3_sessions') || '[]');
                l3All.forEach(session => {
                    state.l3Sessions[session.crewId] = session;
                });
                
                state.logs.forEach(log => touchLiveDevice(log.crewId, log.deviceId, log.timestamp));
            } catch (e) {
                console.warn("Failed to load from localStorage:", e);
            }
        }


</script>
</html>